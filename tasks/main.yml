---
- name: Add Oracle Java apt repository
  apt_repository: repo="ppa:webupd8team/java"

- name: Upgrade all packages
  apt: upgrade=dist update_cache=yes

- name: Install Git
  apt: name=git state=latest

- name: Accept Oracle License
  debconf: name=oracle-java7-installer question='shared/accepted-oracle-license-v1-1' value='true' vtype='select'

- name: Install Java
  apt: name=oracle-java7-installer state=latest

- name: Install Maven
  apt: name=maven state=latest

- name: Install MySQL
  apt: name=mysql-server state=latest

- name: Download watchtower-common-1.0.1-SNAPSHOT
  git: repo=https://github.com/icclab/watchtower-common.git dest="/home/{{ansible_ssh_user}}/watchtower-common"
  when: not release

- name: Download watchtower-common-1.0.0
  get_url: url=https://github.com/icclab/watchtower-common/archive/1.0.0.tar.gz dest="/home/{{ansible_ssh_user}}/"
  when: release

- name: Unpack watchtower-common-1.0.0
  unarchive: src="/home/{{ansible_ssh_user}}/watchtower-common-1.0.0.tar.gz" dest="/home/{{ansible_ssh_user}}/" copy=no
  when: release

- name: Install watchtower-common
  command: mvn clean install
  args:
    chdir: "/home/{{ansible_ssh_user}}/watchtower-common"

- name: Download watchtower-monitoring-1.0.1-SNAPSHOT
  git: repo=https://github.com/icclab/watchtower-monitoring.git dest="/home/{{ansible_ssh_user}}/watchtower-monitoring"
  when: not release

- name: Download watchtower-monitoring-1.0.0
  get_url: url=https://github.com/icclab/watchtower-monitoring/archive/1.0.0.tar.gz dest="/home/{{ansible_ssh_user}}/"
  when: release

- name: Unpack watchtower-monitoring-1.0.0
  unarchive: src="/home/{{ansible_ssh_user}}/watchtower-monitoring-1.0.0.tar.gz" dest="/home/{{ansible_ssh_user}}/" copy=no
  when: release

- name: Package watchtower-monitoring
  command: mvn clean package
  args:
    chdir: "/home/{{ansible_ssh_user}}/watchtower-monitoring"

- name: Install watchtower-monitoring
  apt: deb="/home/{{ansible_ssh_user}}/watchtower-monitoring/debs/binaries/watchtower-monitoring-1.0.1-SNAPSHOT.deb"

- name: Setup watchtower-monitoring
  command: mv /etc/watchtower/monitoring-config.yml-sample /etc/watchtower/monitoring-config.yml
  notify:
    - Restart watchtower-monitoring

- name: Download watchtower-workflow-1.0.1-SNAPSHOT
  git: repo=https://github.com/icclab/watchtower-workflow.git dest="/home/{{ansible_ssh_user}}/watchtower-workflow"
  when: not release

- name: Download watchtower-workflow-1.0.0
  get_url: url=https://github.com/icclab/watchtower-workflow/archive/1.0.0.tar.gz dest="/home/{{ansible_ssh_user}}/"
  when: release

- name: Unpack watchtower-workflow-1.0.0
  unarchive: src="/home/{{ansible_ssh_user}}/watchtower-workflow-1.0.0.tar.gz" dest="/home/{{ansible_ssh_user}}/" copy=no
  when: release

- name: Package watchtower-workflow
  command: mvn clean package
  args:
    chdir: "/home/{{ansible_ssh_user}}/watchtower-workflow"

- name: Install watchtower-workflow
  apt: deb="/home/{{ansible_ssh_user}}/watchtower-workflow/debs/binaries/watchtower-workflow-1.0.1-SNAPSHOT.deb"

- name: Setup watchtower-workflow
  command: mv /etc/watchtower/workflow-config.yml-sample /etc/watchtower/workflow-config.yml
  notify:
    - Restart watchtower-workflow

- name: Download watchtower-automation-1.0.1-SNAPSHOT
  git: repo=https://github.com/icclab/watchtower-automation.git dest="/home/{{ansible_ssh_user}}/watchtower-automation"
  when: not release

- name: Download watchtower-automation-1.0.0
  get_url: url=https://github.com/icclab/watchtower-automation/archive/1.0.0.tar.gz dest="/home/{{ansible_ssh_user}}/"
  when: release

- name: Unpack watchtower-automation-1.0.0
  unarchive: src="/home/{{ansible_ssh_user}}/watchtower-automation-1.0.0.tar.gz" dest="/home/{{ansible_ssh_user}}/" copy=no
  when: release

- name: Package watchtower-automation
  command: mvn clean package
  args:
    chdir: "/home/{{ansible_ssh_user}}/watchtower-automation"

- name: Install watchtower-automation
  apt: deb="/home/{{ansible_ssh_user}}/watchtower-automation/debs/binaries/watchtower-automation-1.0.1-SNAPSHOT.deb"

- name: Setup watchtower-automation
  command: mv /etc/watchtower/automation-config.yml-sample /etc/watchtower/automation-config.yml
  notify:
    - Restart watchtower-automation
